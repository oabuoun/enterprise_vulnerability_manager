import requests
from json.decoder import JSONDecodeError
import time
from MySQL import MySQL
# Connect to database server and input CVE ID, CVSS, Description for each new vulnerability found

url = 'https://plasticuproject.pythonanywhere.com/nvd-api/v1/'
full_url = ''

# This function takes a list of products as a parameter
def cve_search(keywords, type='recent'):
    cves = {}
    for keyword in keywords:
        print('Currently scanning:', keyword)
        if type == 'recent':
            year = 'recent'
            date = ''
        elif type == 'init':
            year = 'year/'
            date = '2021'
        global full_url
        full_url = url + year + date + '?keyword=' + keyword
        res = requests.get(url + year + date + '?keyword=' + keyword)
        for i in res.json():
            try:
                cves[i['cve']['CVE_data_meta']['ID']] = [i['cve']['description']['description_data'][0]['value'], i['impact']['baseMetricV3']['cvssV3']['baseScore'], i['lastModifiedDate']]
            except:
                cves[i['cve']['CVE_data_meta']['ID']] = [i['cve']['description']['description_data'][0]['value'], "No CVSS score found", i['lastModifiedDate'], keyword]
        time.sleep(2)
    if len(cves) == 0:
        return "No CVEs found"
    else:
        new_records = MySQL.dupe_check(cves)
        return new_records

def test_cve_search():
    cve_search(['nvidia'])
    assert full_url == 'https://plasticuproject.pythonanywhere.com/nvd-api/v1/recent?keyword=nvidia'


if __name__ == '__main__':
    cve_search(['nvidia'])
