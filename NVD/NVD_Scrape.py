import requests
from json.decoder import JSONDecodeError
import time
# Connect to database server and input CVE ID, CVSS, Description for each new vulnerability found

url = 'https://plasticuproject.pythonanywhere.com/nvd-api/v1/'
full_url = ''

# This function takes a list of products as a parameter
def cve_search(keywords):
    cves = {}
    for keyword in keywords:
        print('Currently scanning:', keyword)
        year = 'recent'
        date = ''
        global full_url
        full_url = url + year + date + '?keyword=' + keyword
        res = requests.get(url + year + date + '?keyword=' + keyword)
        for i in res.json():
            try:
                cves[i['cve']['CVE_data_meta']['ID']] = i['cve']['description']['description_data'][0]['value'], i['impact']['baseMetricV3']['cvssV3']['baseScore'], i['lastModifiedDate']
            except:
                cves[i['cve']['CVE_data_meta']['ID']] = i['cve']['description']['description_data'][0]['value'], "No CVSS score found", i['lastModifiedDate']
        time.sleep(2)
    if len(cves) == 0:
        print("No results were found for " + keyword)
        quit()
    for ID, description in cves.items():
        print('\n' + ID)
        print(description[0])
        print('Score:', str(description[1]))
        print("Last Modified:", str(description[2][:-7]) + '\n')
    if len(cves) > 1:
        print('Results found: ', str(len(cves)))
        print()

def test_cve_search():
    cve_search(['nvidia'])
    assert full_url == 'https://plasticuproject.pythonanywhere.com/nvd-api/v1/recent?keyword=nvidia'


if __name__ == '__main__':
    cve_search(['nvidia'])
