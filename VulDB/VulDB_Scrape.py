import requests
import urllib.parse
import datetime
from MySQL import MySQL

records = {}
api_key = '5f3b28c56203f3c3c5927c87afae36fe'
url = 'https://vuldb.com/?api'
def cve_search(keywords):
    for keyword in keywords:
        PARAMS = {'apikey': '5f3b28c56203f3c3c5927c87afae36fe', 'search': str(keyword), 'fields': 'source_cve,entry_title,vulnerability_cvss3_vuldb_basescore'}
        res = requests.post(url, data=PARAMS)
        json_res = res.json()
        for i in range(len(json_res['result'])):
            # Go through every CVE and get the information
            CVE_id = json_res['result'][i]['source']['cve']['id']
            CVE_title = json_res['result'][i]['entry']['title']
            CVE_score = json_res['result'][i]['vulnerability']['cvss3']['vuldb']['basescore']
            CVE_publish_time_epoch = json_res['result'][i]['entry']['timestamp']['change']
            CVE_publish_time = datetime.datetime.fromtimestamp(int(CVE_publish_time_epoch)).date()
            records[CVE_id] = [CVE_title, CVE_score, str(CVE_publish_time), keyword]
    new_records = MySQL.dupe_check(records)
    return new_records

if __name__ == '__main__':
    cve_search(['Microsoft Office'])