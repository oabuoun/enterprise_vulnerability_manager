from flask import Flask, make_response, request, render_template, redirect, jsonify, flash
from random import random
#import jwt
import datetime
import sqlite3
from contextlib import closing
import time
import yagmail
import sendaccountemail as sendaccountemail
from password_strength import PasswordPolicy
from password_strength import PasswordStats
import passwordcheck as passwordcheck

flaskapp = Flask(__name__)

policy = PasswordPolicy.from_names(
    length= 8,
    uppercase=1,
    numbers=1,
    special=1,
    strength=0.5
)
flaskapp.config['SECRET_KEY'] = '@#$%^&*('

@flaskapp.route('/createpass', methods = ['GET','POST'])
def createpass():
    if request.method =='POST':
        password = request.form.get('password')
        checkpolicy = policy.test(password)
        stats = PasswordStats(password)
        if stats.strength() < 0.5:
            print(stats.strength())
            flash("Password not strong enough. Avoid consecutive characters and easily guessed words.")
            resp=make_response(redirect('pass_create.html'))
            return resp
        else:
            print(stats.strength())
            print("success")
            return render_template('success.html')
    return render_template('pass_create.html')

@flaskapp.route('/', methods=['POST','GET'])
def send():
    return render_template('user_create.html')

@flaskapp.route('/success', methods=['GET','POST'])
def success():
    return render_template('success.html')

@flaskapp.route('/sendemail', methods = ['POST'])
def createaccount():
    print(request.form)
    name = request.form.get('name', type = str)
    sname = request.form.get('sname', type = str)
    mail = request.form.get('mail', type = str)
    dob = request.form.get('dob', type = str)
    yob=dob[0:4]
    daob=dob[8:10]
    mob=dob[5:7]
    dmob=daob+mob
    mdob=mob+daob
    if mob == '01':
        m3ob = "jan"
    elif mob == '02':
        m3ob = "feb"
    elif mob == '03':
        m3ob = "mar"
    elif mob == '04':
        m3ob = "apr"
    elif mob == '05':
        m3ob = "may"
    elif mob == '06':
        m3ob = "jun"
    elif mob == '07':
        m3ob = "jul"
    elif mob == '08':
        m3ob = "aug"
    elif mob == '09':
        m3ob = "sep"
    elif mob == '10':
        m3ob = "oct"
    elif mob == '11':
        m3ob = "nov"
    elif mob == '12':
        m3ob = "dec"
    else:
        return None
    userinfolist =[name.lower(),sname.lower(),yob,dmob,mdob,m3ob]
    result = sendaccountemail.gomail(mail, name, userinfolist)
    response_data = {
        'data': result
    }
    return make_response(jsonify(response_data))

if __name__ == "__main__":
    flaskapp.run(host='0.0.0.0', debug = True, ssl_context = ('cert/cert.pem', 'cert/key.pem'))
