provider "aws" {
  region = var.var_region
}

# Backend
terraform {
  backend "s3" {
    bucket = "cyber-vulnerability-scanner-bucket"
    key = "tfstate/vuln_scan/terraform.tfstate"
    region = "eu-west-1"
    dynamodb_table = "cyber_vulnerability_scanner_dynamodb_table_lock"
    encrypt = true
  }
}

# Virtual Private Cloud
module "vpc" {
  source = "./modules/vpc"
}

# App Subnet
module "app_subnet" {
  source = "./modules/app_subnet"

  var_internet_rt = module.vpc.output_internet_rt
  var_aws_vpc_id = module.vpc.output_aws_vpc_id
}

# Bastion Subnet
module "bastion_subnet" {
  source = "./modules/bastion_subnet"

  var_internet_rt = module.vpc.output_internet_rt
  var_aws_vpc_id = module.vpc.output_aws_vpc_id
}

# Database Subnet
module "database_subnet" {
  source = "./modules/database_subnet"

  var_internet_rt = module.vpc.output_internet_rt
  var_aws_vpc_id = module.vpc.output_aws_vpc_id
}

# Nginx Subnet
module "nginx_subnet" {
  source = "./modules/nginx_subnet"

  var_internet_rt = module.vpc.output_internet_rt
  var_aws_vpc_id = module.vpc.output_aws_vpc_id
}

# App Server
module "app_server" {
  source = "./modules/app_server"

  var_aws_vpc_id = module.vpc.output_aws_vpc_id
  var_app_subnet_id = module.app_subnet.output_app_subnet_id
}

# Bastion Server
module "bastion_server" {
  source = "./modules/bastion_server"

  var_aws_vpc_id = module.vpc.output_aws_vpc_id
  var_bastion_subnet_id = module.bastion_subnet.output_bastion_subnet_id
}

# Database Server
module "database_server" {
  source = "./modules/database_server"

  var_aws_vpc_id = module.vpc.output_aws_vpc_id
  var_db_subnet_id = module.database_subnet.output_db_subnet_id
}

# Nginx Server
module "nginx_server" {
  source = "./modules/nginx_server"

  var_aws_vpc_id = module.vpc.output_aws_vpc_id
  var_nginx_subnet_id = module.nginx_subnet.output_nginx_subnet_id
}
